//@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
//@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
//@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@###########@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
//@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#SS%%%???????????????%%%SS#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
//@@@@@@@@@@@@@@@@@@@@@@@@@@@#S%%???%%%%%%%%%%%%%%????????????%S#@@@@@@@@@@@@@@@@@@@@@@@@@@@
//@@@@@@@@@@@@@@@@@@@@@@@@#%%%%SSSSSSSSS%%%SSSSSSSSSSS%%??????????%S@@@@@@@@@@@@@@@@@@@@@@@@
//@@@@@@@@@@@@@@@@@@@@@#S%SSSS%%%???????????????????%%SSSSS%?????????S#@@@@@@@@@@@@@@@@@@@@@
//@@@@@@@@@@@@@@@@@@#SSSSS%%????????????%%%SSSSSSSSS%%%??%%SSS%????????%#@#@@@@@@@@@@@@@@@@@
//@@@@@@@@@@@@@@@@#SSSS%??????????%SS#@@@@@@@@@@@@@@@@@@@#S%%%SS%%???????%SSS@@@@@@@@@@@@@@@
//@@@@@@@@@@@@@@@#SS%?????????%S#@@@@@@@@@@@@@@@@@@@@@@##@@@@##S%SS%???????SS%S@@@@@@@@@@@@@
//@@@@@@@@@@@@@@@S %????????%#@@@@@@@@@@@@@@#@@@@@#S@@@S?%@@@@@@@@#SSS%??????%#%%#@@@@@@@@@@
//@@@@@@@@@@@@@S %???????%S@@@@@@@@@@@@@@@SS#@#SSS#@#S??%@@@@@@@@@@@###%???????SS?S@@@@@@@@@
//@@@@@@@@@@@@%???????%SS#@@@@@@@@@@@@#%%%SSSSS#SS%?%S#@@@@@@@@@@@@@@@@#???????#S?S@@@@@@@@@
//@@@@@@@@@@#???????%SSS#@@@@@@@@@@@#S???%??%%%%%S##@@@#SS%%%S@@@@@@@@@@#%??????#%?%@@@@@@@@
//@@@@@@@@@S ???????SS%S@@@@@@@@@@@@S???????%%S###SSSS%????%%SSSSSSSS#@@@@@%?????%#??%@@@@@@
//@@@@@@@@S ??????%SS?S@@@@@@@@@@#S???????%S#SS%???%??????????????%%S##@@@@@%?????SS??S@@@@@
//@@@@@@@#??????%#%?S@@@@@@@@@S%?????????S@S%%???????????????????%%SS#@@@@@#?????%#???#@@@@@
//@@@@@@@%?????%#%?S@@@@@@@#%???%%???????%%%%SS%?????????????????????%%S@@@@S?????#%??%@@@@@
//@@@@@@S ?????%#%?%@@@@@@@#???%@S%????????%%SS#@%???????????????????%S###@@@@?????SS???#@@@
//@@@@@@%?????#%??S@@@@#S%????%%???????%SSSSSS#@@##SS%%???????????????%#@@@@@S????#S???%@@@@
//@@@@@@?????SS???@@S%???????%%S###%??%S%?%SS#@@@@@@@@@@S%??????????????%@@@@#????#S???%@@@@
//@@@@@@?????#%???@S????%%%S#@@@@@@%??????%#@@@@@@@@@@@@@@#%?????????????%@@@#????S%????#@@@
//@@@@@@????%#????@#%%##@@@@@@@@@@#???%%%#@@@@@@@@@@@@@@@@@@%??????????%#%%@@#???%#%????@@@@
//@@@@@@????SS????@@@@@@@@@@@@@@@#%?%#@@@@@@@@@@@@@@@@@@@@@@@%??????????#@#@@#???SS?????@@@@
//@@@@@@????S%????#@@@@@@@@@@##%???%@@@@@@@@@@@@@@@@@@@@@@@@@#??????????S@@@@S??%#%????%@@@@
//@@@@@@%???S%????S@@@@@@@@@@#%???S@@@@@@@@@@@@@@@@@@@@@@@@@@#??????????S@@@@%??SS?????S@@@@
//@@@@@@S ???S%????%@@@@@@@@@@@@##@@@@@@@@@@@@@@@@@@@@@@@@@@@@#??????????#@@@S??SS?????%@@@@
//@@@@@@@%??SS?????S@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@S??????%%?S@@@@%?SS??????S@@@@@
//@@@@@@@S ??%#??????#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#%?????S@@#@@@@%?SS??????%@@@@@
//@@@@@@@@%??SS?????%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%????%#@@@@@@@%%S%??????%@@@@@@@
//@@@@@@@@@%?%#%?????%#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#%???%S@@@@@@@#%%S%??????%@@@@@@@@
//@@@@@@@@@@%?%S??????%#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@S???%#@@@@@@@@S%S%???????S@@@@@@@@@
//@@@@@@@@@@@S? SS???????S@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#S??%S@@@@@@@@@@SS%???????%#@@@@@@@@@
//@@@@@@@@@@@@S?SS???????%###@@@@@@@@@@@@@@@@@@@@@@@#SSS#@@@@@@@@@@@@S%????????S@@@@@@@@@@@@
//@@@@@@@@@@@@@#%%S%???????%SSS#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#%%????????%S@@@@@@@@@@@@@
//@@@@@@@@@@@@@@@S%SS????????%SSSS#@@@@@@@@@@@@@@@@@@@@@@@@@@@#S%?????????%SSS#@@@@@@@@@@@@@
//@@@@@@@@@@@@@@@@@SSS%????????%SSS%%%S#@@@@@@@@@@@@@@@@##S%%??????????%SSSS#@@@@@@@@@@@@@@@
//@@@@@@@@@@@@@@@@@@@###%????????%%SSS%%??%%%%%%%%%%%%%????????????%%SS%%S#@@@@@@@@@@@@@@@@@
//@@@@@@@@@@@@@@@@@@@@@@@#S%?????????%%SSSS%%%??????????????%%%%SSSS%%%S@@@@@@@@@@@@@@@@@@@@
//@@@@@@@@@@@@@@@@@@@@@@@@@@#S%??????????%%%SSSSSSSSSSSSSSSSSS%%%??%S@@@@@@@@@@@@@@@@@@@@@@@
//@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#S%%????????????????%%%????????%%S#@@@@@@@@@@@@@@@@@@@@@@@@@@
//@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#SS%%?????????????%%%SS##@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
//@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@########@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
//@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
//@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ 








const tabs = document.querySelectorAll('.tab-button');
const contents = document.querySelectorAll('.tab-content');

tabs.forEach(tab => {
  tab.addEventListener('click', () => {
    const target = tab.dataset.tab;

    tabs.forEach(btn => btn.classList.remove('active'));
    tab.classList.add('active');

    contents.forEach(content => content.classList.add('hidden'));
    document.getElementById(target).classList.remove('hidden');
  });
});

// Example dynamic values
document.getElementById("pc-name").textContent = navigator.platform;
document.getElementById("expiry").textContent = "∞";



async function loadIniData() {
  try {
    const response = await fetch('/configdata');
    if (!response.ok) throw new Error('Error loading INI data');
    const iniData = await response.json();

    for (const [key, value] of Object.entries(iniData)) {
      if (!(key in map)) continue;

      const [type, selector, index] = map[key];
      const inputs = document.querySelectorAll(selector);
      const input = inputs[index];
      if (!input) continue;

      if (type === "checkbox") {
        input.checked = value.toLowerCase() === "true";
      } else {
        input.value = value;

        //AIMBOT
        if (key === "Aim_FOV") {
          const fovValueDisplay = document.getElementById('aimbot_fov_val');
          if (fovValueDisplay) fovValueDisplay.textContent = value;
        }
        if (key === "Acceleration") {
          const fovValueDisplay = document.getElementById('aimbot_acceleration_val');
          if (fovValueDisplay) fovValueDisplay.textContent = value;
        }
        if (key === "Auto_Fire_MS") {
          const autoFireDisplay = document.getElementById('aimbot_auto_fire_ms_val');
          if (autoFireDisplay) autoFireDisplay.textContent = value + "ms";
        }

        //ESP
        if (key === "ESP_Size") {
          const espSizeValueDisplay = document.getElementById('esp_size_val');
          if (espSizeValueDisplay) espSizeValueDisplay.textContent = value;
        }

        if (key === "ESP_Max_Distance") {
          const espDistanceValueDisplay = document.getElementById('esp_distance_val');
          if (espDistanceValueDisplay) espDistanceValueDisplay.textContent = value + "m";
        }


        //MISC
        if (key === "Crosshair_Size") {
          const miscCrossHairValueDisplay = document.getElementById('misc_crosshair_size_val');
          if (miscCrossHairValueDisplay) miscCrossHairValueDisplay.textContent = value;
        }

        if (key === "Crosshair_Thickness") {
          const miscThicknessValueDisplay = document.getElementById('misc_crosshair_thickness_val');
          if (miscThicknessValueDisplay) miscThicknessValueDisplay.textContent = value;
        }

        if (key === "Text_Size") {
          const miscTextSizeValueDisplay = document.getElementById('misc_text_size_val');
          if (miscTextSizeValueDisplay) miscTextSizeValueDisplay.textContent = value;
        }

      }
    }

    // Call the stickman update after loading data
    if (typeof window.updateStickmanPanelStyle === "function") {
      window.updateStickmanPanelStyle();
    }

  } catch (err) {
    console.error(err);
  }
}




function sendIniUpdate(key, value) {
  fetch('/updateconfig', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ key, value })
  }).then(res => {
    if (!res.ok) {
      console.error("Échec de la mise à jour INI pour", key);
    }
  });
}

function bindInputsToIniUpdates(dataMap) {
  for (const [key, value] of Object.entries(dataMap)) {
    const [type, selector, index] = value;
    const inputs = document.querySelectorAll(selector);
    const input = inputs[index];
    if (!input) continue;

    const handler = () => {
      let val;
      if (type === "checkbox") val = input.checked.toString();
      else val = input.value.toString();
      sendIniUpdate(key, val);
    };

    input.addEventListener("change", handler);
    input.addEventListener("input", handler);
  }
}

const map = {
  // [AIMBOT]
  "Enable_AIMBOT": ["checkbox", "#aimbot input[type='checkbox']", 0],
  "Aim_FOV": ["range", "#aimbot input[type='range']", 0],
  "Draw_Aim_Fov": ["checkbox", "#aimbot input[type='checkbox']", 1],
  "Draw_Enemy_Close": ["checkbox", "#aimbot input[type='checkbox']", 2],
  "Acceleration": ["range", "#aimbot input[type='range']", 1],
  "AIM_Key": ["select", "#aimbot select", 0],
  "Aim_Filter": ["select", "#aimbot select", 1],
  "Aim_Target": ["select", "#aimbot select", 2],
  "Auto_Fire": ["checkbox", "#aimbot input[type='checkbox']", 3],
  "Auto_Fire_MS": ["range", "#aimbot input[type='range']", 2],

  // [ESP]
  "Enable_ESP": ["checkbox", "#esp input[type='checkbox']", 0],
  "ESP_Form": ["select", "#esp select", 0],
  "ESP_Size": ["range", "#esp input[type='range']", 0],
  "ESP_Max_Distance": ["range", "#esp input[type='range']", 1],
  "Show_Allies": ["checkbox", "#esp input[type='checkbox']", 1],
  "Show_Player_Names": ["checkbox", "#esp input[type='checkbox']", 2],
  "Show_Distance": ["checkbox", "#esp input[type='checkbox']", 3],
  "Enable_Snapline": ["checkbox", "#esp input[type='checkbox']", 4],
  "Snapline_Size": ["range", "#esp input[type='range']", 2],
  "Snapline_Starting_Point": ["select", "#esp select", 1],

  // [MISC]
  "Enable_CROSSHAIR": ["checkbox", "#misc input[type='checkbox']", 0],
  "Crosshair_Size": ["range", "#misc input[type='range']", 0],
  "Crosshair_Thickness": ["range", "#misc input[type='range']", 1],
  "Show_Text_Border": ["checkbox", "#misc input[type='checkbox']", 1],
  "Text_Size": ["range", "#misc input[type='range']", 2],
  "Font_Text": ["text", "#misc input[type='text']", 0],
  "Enable_VSAT": ["checkbox", "#misc input[type='checkbox']", 2],

  // [STYLES]
  "Enemies_Color": ["color", "#styles input[type='color']", 0],
  "Allies_Color": ["color", "#styles input[type='color']", 1],
  "Filled_Border_Color": ["color", "#styles input[type='color']", 2],
  "Snapline_Color": ["color", "#styles input[type='color']", 3],
  "Crosshair_Color": ["color", "#styles input[type='color']", 4],
  "FOV_Color": ["color", "#styles input[type='color']", 5],
  "Player_Name_Color": ["color", "#styles input[type='color']", 6],
  "Player_Ping_Color": ["color", "#styles input[type='color']", 7],
  "Background": ["color", "#styles input[type='color']", 8],

  // [SETTINGS]
  "Show_FPS": ["checkbox", "#settings input[type='checkbox']", 1],
  "Show_Menu": ["select", "#settings select", 0],
  "VSYNC": ["checkbox", "#settings input[type='checkbox']", 2],
  "FPS": ["number", "#settings input[type='number']", 0],
  "FPS_Corner": ["select", "#settings select", 1],
  "Show_Overlay": ["checkbox", "#settings input[type='checkbox']", 0],
  "Anti_Aliasing": ["checkbox", "#settings input[type='checkbox']", 3],
  "GameWidth": ["number", "#settings input[type='number']", 1],
  "GameHeight": ["number", "#settings input[type='number']", 2],
};

// WebSocket setup
let socket;

function initWebSocket() {
  const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
  const wsUrl = `${protocol}//${location.host}/`;

  socket = new WebSocket(wsUrl);

  socket.addEventListener('open', () => {
    console.log("WebSocket connected");
  });

  socket.addEventListener('message', async (event) => {
    try {
      const data = JSON.parse(event.data);

      if (data.type === "configUpdated") {
        console.log("Config mise à jour reçue via WebSocket, rechargement...");
        await loadIniData();
      }

      if (data.type === "fpsUpdate") {
        const fpsDisplay = document.getElementById("fps-display");
        if (fpsDisplay) {
          fpsDisplay.textContent = "FPS: " + data.fps;
        }
      }

    } catch (err) {
      console.error("Erreur lors du traitement du message WebSocket :", err);
    }
  });


  socket.addEventListener('close', () => {
    console.log("WebSocket fermé, tentative de reconnexion dans 3s...");
    setTimeout(initWebSocket, 3000); // Reconnect après 3s
  });

  socket.addEventListener('error', (err) => {
    console.error("Erreur WebSocket :", err);
    socket.close();
  });
}

window.addEventListener('DOMContentLoaded', () => {
  loadIniData().then(() => {
    bindInputsToIniUpdates(map);
  });

  initWebSocket();

  const shutdownBtn = document.getElementById('btnShutdown');
  shutdownBtn.addEventListener('click', () => {
    if (socket && socket.readyState === WebSocket.OPEN) {
      socket.send(JSON.stringify({ type: 'shutdown' }));
    } else {
      console.error("WebSocket not connected");
    }
    window.close();
  });
});
