//@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
//@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
//@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@###########@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
//@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#SS%%%???????????????%%%SS#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
//@@@@@@@@@@@@@@@@@@@@@@@@@@@#S%%???%%%%%%%%%%%%%%????????????%S#@@@@@@@@@@@@@@@@@@@@@@@@@@@
//@@@@@@@@@@@@@@@@@@@@@@@@#%%%%SSSSSSSSS%%%SSSSSSSSSSS%%??????????%S@@@@@@@@@@@@@@@@@@@@@@@@
//@@@@@@@@@@@@@@@@@@@@@#S%SSSS%%%???????????????????%%SSSSS%?????????S#@@@@@@@@@@@@@@@@@@@@@
//@@@@@@@@@@@@@@@@@@#SSSSS%%????????????%%%SSSSSSSSS%%%??%%SSS%????????%#@#@@@@@@@@@@@@@@@@@
//@@@@@@@@@@@@@@@@#SSSS%??????????%SS#@@@@@@@@@@@@@@@@@@@#S%%%SS%%???????%SSS@@@@@@@@@@@@@@@
//@@@@@@@@@@@@@@@#SS%?????????%S#@@@@@@@@@@@@@@@@@@@@@@##@@@@##S%SS%???????SS%S@@@@@@@@@@@@@
//@@@@@@@@@@@@@@@S %????????%#@@@@@@@@@@@@@@#@@@@@#S@@@S?%@@@@@@@@#SSS%??????%#%%#@@@@@@@@@@
//@@@@@@@@@@@@@S %???????%S@@@@@@@@@@@@@@@SS#@#SSS#@#S??%@@@@@@@@@@@###%???????SS?S@@@@@@@@@
//@@@@@@@@@@@@%???????%SS#@@@@@@@@@@@@#%%%SSSSS#SS%?%S#@@@@@@@@@@@@@@@@#???????#S?S@@@@@@@@@
//@@@@@@@@@@#???????%SSS#@@@@@@@@@@@#S???%??%%%%%S##@@@#SS%%%S@@@@@@@@@@#%??????#%?%@@@@@@@@
//@@@@@@@@@S ???????SS%S@@@@@@@@@@@@S???????%%S###SSSS%????%%SSSSSSSS#@@@@@%?????%#??%@@@@@@
//@@@@@@@@S ??????%SS?S@@@@@@@@@@#S???????%S#SS%???%??????????????%%S##@@@@@%?????SS??S@@@@@
//@@@@@@@#??????%#%?S@@@@@@@@@S%?????????S@S%%???????????????????%%SS#@@@@@#?????%#???#@@@@@
//@@@@@@@%?????%#%?S@@@@@@@#%???%%???????%%%%SS%?????????????????????%%S@@@@S?????#%??%@@@@@
//@@@@@@S ?????%#%?%@@@@@@@#???%@S%????????%%SS#@%???????????????????%S###@@@@?????SS???#@@@
//@@@@@@%?????#%??S@@@@#S%????%%???????%SSSSSS#@@##SS%%???????????????%#@@@@@S????#S???%@@@@
//@@@@@@?????SS???@@S%???????%%S###%??%S%?%SS#@@@@@@@@@@S%??????????????%@@@@#????#S???%@@@@
//@@@@@@?????#%???@S????%%%S#@@@@@@%??????%#@@@@@@@@@@@@@@#%?????????????%@@@#????S%????#@@@
//@@@@@@????%#????@#%%##@@@@@@@@@@#???%%%#@@@@@@@@@@@@@@@@@@%??????????%#%%@@#???%#%????@@@@
//@@@@@@????SS????@@@@@@@@@@@@@@@#%?%#@@@@@@@@@@@@@@@@@@@@@@@%??????????#@#@@#???SS?????@@@@
//@@@@@@????S%????#@@@@@@@@@@##%???%@@@@@@@@@@@@@@@@@@@@@@@@@#??????????S@@@@S??%#%????%@@@@
//@@@@@@%???S%????S@@@@@@@@@@#%???S@@@@@@@@@@@@@@@@@@@@@@@@@@#??????????S@@@@%??SS?????S@@@@
//@@@@@@S ???S%????%@@@@@@@@@@@@##@@@@@@@@@@@@@@@@@@@@@@@@@@@@#??????????#@@@S??SS?????%@@@@
//@@@@@@@%??SS?????S@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@S??????%%?S@@@@%?SS??????S@@@@@
//@@@@@@@S ??%#??????#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#%?????S@@#@@@@%?SS??????%@@@@@
//@@@@@@@@%??SS?????%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%????%#@@@@@@@%%S%??????%@@@@@@@
//@@@@@@@@@%?%#%?????%#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#%???%S@@@@@@@#%%S%??????%@@@@@@@@
//@@@@@@@@@@%?%S??????%#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@S???%#@@@@@@@@S%S%???????S@@@@@@@@@
//@@@@@@@@@@@S? SS???????S@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#S??%S@@@@@@@@@@SS%???????%#@@@@@@@@@
//@@@@@@@@@@@@S?SS???????%###@@@@@@@@@@@@@@@@@@@@@@@#SSS#@@@@@@@@@@@@S%????????S@@@@@@@@@@@@
//@@@@@@@@@@@@@#%%S%???????%SSS#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#%%????????%S@@@@@@@@@@@@@
//@@@@@@@@@@@@@@@S%SS????????%SSSS#@@@@@@@@@@@@@@@@@@@@@@@@@@@#S%?????????%SSS#@@@@@@@@@@@@@
//@@@@@@@@@@@@@@@@@SSS%????????%SSS%%%S#@@@@@@@@@@@@@@@@##S%%??????????%SSSS#@@@@@@@@@@@@@@@
//@@@@@@@@@@@@@@@@@@@###%????????%%SSS%%??%%%%%%%%%%%%%????????????%%SS%%S#@@@@@@@@@@@@@@@@@
//@@@@@@@@@@@@@@@@@@@@@@@#S%?????????%%SSSS%%%??????????????%%%%SSSS%%%S@@@@@@@@@@@@@@@@@@@@
//@@@@@@@@@@@@@@@@@@@@@@@@@@#S%??????????%%%SSSSSSSSSSSSSSSSSS%%%??%S@@@@@@@@@@@@@@@@@@@@@@@
//@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#S%%????????????????%%%????????%%S#@@@@@@@@@@@@@@@@@@@@@@@@@@
//@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#SS%%?????????????%%%SS##@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
//@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@########@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
//@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
//@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ 



(function () {
  const widgets = document.getElementById("widgets");
  const toggle = document.getElementById("stickman-toggle");
  const panel = document.getElementById("stickman-panel");
  const crosshairPanel = document.getElementById("crosshair-panel");
  const crosshair = document.getElementById("crosshair");
  const formSelect = document.getElementById("esp_form");
  const espSize = document.getElementById("esp_size");
  const miscCrosshairSizeInput = document.getElementById("misc_crosshair_size");
  const miscCrosshairThicknessInput = document.getElementById("misc_crosshair_thickness");

  const borderColorInput = document.getElementById("style_border_color");
  const crosshairColorInput = document.getElementById("style_crosshair_color");
  const styleNameColorColorInput = document.getElementById("style_name_color");

  const characterNamesCheckBox = document.getElementById("esp_show_character_names");
  const characterNames = document.querySelectorAll(".pseudo");

  // Added: tab buttons for toggling between ESP and MISC
  const tabs = document.querySelectorAll(".tab-button");

  tabs.forEach(tab => {
    tab.addEventListener("click", () => {
      if (widgets) widgets.style.display = "none";
      if (panel) panel.style.display = "none";
      if (crosshairPanel) crosshairPanel.style.display = "none";
    });
  });


  function updatePanelStyle() {
    if (!panel) return;

    // ESP
    const formValue = formSelect?.value || "1";
    const sizeValue = espSize?.value || "1";

    const charNamesVisible = characterNamesCheckBox?.checked;
    characterNames.forEach(el => {
      if (charNamesVisible) {
        el.classList.remove("hidden");
      } else {
        el.classList.add("hidden");
      }
    });

    // Handle distance display
    const showDistance = document.getElementById("esp_show_distances")?.checked;
    characterNames.forEach(el => {
      let distanceSpan = el.querySelector(".distance");

      // Stop any existing interval if hidden
      if (!showDistance) {
        if (distanceSpan) {
          const intervalId = distanceSpan.dataset.intervalId;
          if (intervalId) clearInterval(parseInt(intervalId));
          distanceSpan.remove();
        }
        return;
      }

      // Create distance span if it doesn't exist
      if (!distanceSpan) {
        distanceSpan = document.createElement("span");
        distanceSpan.className = "distance";
        el.appendChild(distanceSpan);

        // Start dynamic value
        let distance = 5;
        let increasing = true;

        const intervalId = setInterval(() => {
          if (increasing) {
            distance += 50;
            if (distance >= 5000) increasing = false;
          } else {
            distance -= 50;
            if (distance <= 15) increasing = true;
          }

          distanceSpan.textContent = `[${Math.floor(distance / 10)}m]`;

        }, 60);

        // Store interval ID to clean up later
        distanceSpan.dataset.intervalId = intervalId.toString();
      }
    });

    // MISC
    const miscCrosshairSizeValue = miscCrosshairSizeInput?.value || "1";
    const miscCrosshairThicknessValue = miscCrosshairThicknessInput?.value || "1";

    crosshair.style.padding = `${miscCrosshairSizeValue}px `;

    crosshair.style.setProperty('--crosshair-thickness', `${miscCrosshairThicknessValue}px`);

    // STYLES
    const borderColor = borderColorInput?.value || "#ff0000";
    const stylesCrossHairColorValue = crosshairColorInput?.value || "#ff0000";
    const stylesPlayerNameColorValue = styleNameColorColorInput?.value || "#ff0000";

    // Reset styles
    panel.classList.remove("rectangle", "edges", "filled", "ellipse");
    panel.style.border = "none";
    panel.style.backgroundColor = "transparent";
    panel.style.borderRadius = "0";

    // Apply ESP styles
    switch (formValue) {
      case "1":
        panel.classList.add("rectangle");
        panel.style.border = `${sizeValue}px solid ${borderColor}`;
        break;
      case "2":
        panel.classList.add("edges");
        panel.style.border = `${sizeValue}px dashed ${borderColor}`;
        break;
      case "3":
        panel.classList.add("filled");
        panel.style.border = `${sizeValue}px solid ${borderColor}`;
        panel.style.backgroundColor = borderColor + "33";
        break;
      case "4":
        panel.classList.add("ellipse");
        panel.style.border = `${sizeValue}px solid ${borderColor}`;
        panel.style.borderRadius = "50%";
        break;
    }

    //STYLES
    crosshair.style.setProperty('--crosshair-color', `${stylesCrossHairColorValue}`);

    characterNames.forEach((el) => {
      el.style.color = stylesPlayerNameColorValue;
      const span = el.querySelector("span");
      if (span) {
        span.style.color = stylesPlayerNameColorValue;
      }
    });
  }



  toggle?.addEventListener("click", () => {
    const activeTab = document.querySelector(".tab-button.active")?.dataset.tab;

    if (activeTab === "esp") {
      widgets.style.display = widgets.style.display === "none" || !widgets.style.display ? "flex" : "none";

      if (panel) {
        panel.style.display = panel.style.display === "none" || !panel.style.display ? "block" : "none";
      }

    } else if (activeTab === "misc") {
      if (crosshairPanel) {
        widgets.style.display = widgets.style.display === "none" || !widgets.style.display ? "flex" : "none";

        crosshairPanel.style.display = crosshairPanel.style.display === "none" || !crosshairPanel.style.display ? "flex" : "none";
      }
    }

    else if (activeTab === "styles") {
      widgets.style.display = widgets.style.display === "none" || !widgets.style.display ? "flex" : "none";

      if (panel) {
        panel.style.display = panel.style.display === "none" || !panel.style.display ? "block" : "none";
      }
      if (crosshairPanel) {
        crosshairPanel.style.display = crosshairPanel.style.display === "none" || !crosshairPanel.style.display ? "flex" : "none";
      }
    }

  });

  // Listeners
  formSelect?.addEventListener("change", updatePanelStyle);
  espSize?.addEventListener("change", updatePanelStyle);
  characterNamesCheckBox?.addEventListener("change", updatePanelStyle);
  miscCrosshairSizeInput?.addEventListener("change", updatePanelStyle);
  document.getElementById("esp_show_distances")?.addEventListener("change", updatePanelStyle);
  borderColorInput?.addEventListener("input", updatePanelStyle);

  // Initialize crosshair panel as hidden
  if (crosshairPanel) crosshairPanel.style.display = "none";

  // Initialize display based on active tab on load
  const activeTab = document.querySelector(".tab-button.active");
  if (activeTab?.dataset.tab === "esp") {
    if (panel) panel.style.display = "block";
  } else {
    if (panel) panel.style.display = "none";
  }

  // Expose globally
  window.updateStickmanPanelStyle = updatePanelStyle;

  // Initial render
  updatePanelStyle();
})();
